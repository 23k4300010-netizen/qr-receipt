<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phiếu mua sắm</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 980px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 12px; }
    .muted { color:#666; }
    .err { color:#b00020; white-space: pre-wrap; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    code { background:#f6f6f6; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>Phiếu mua sắm</h2>
  <p class="muted">
    Trang này đọc dữ liệu từ blockchain (Sepolia). Nếu bạn mở bằng điện thoại, không cần MetaMask vẫn xem được.
  </p>

  <div class="card">
    <div><b>Contract:</b> <code id="caddr"></code></div>
    <div><b>Mã phiếu:</b> <code id="pid"></code></div>
    <p id="status" class="muted"></p>
    <p id="error" class="err"></p>
  </div>

  <div id="content" class="card" style="display:none;">
    <h3>Chi tiết phiếu</h3>
    <div><b>Chủ sở hữu:</b> <code id="owner"></code></div>
    <div><b>Tên khách:</b> <span id="name"></span></div>
    <div><b>SĐT:</b> <span id="phone"></span></div>
    <div><b>Tổng tiền:</b> <span id="total"></span></div>
    <div><b>Thời điểm mua (unix):</b> <span id="time"></span></div>
    <div><b>Tranh chấp:</b> <span id="dispute"></span></div>
    <div><b>Chuyển nhượng:</b> <span id="transfer"></span></div>
<hr style="margin:16px 0; border:none; border-top:1px solid #eee;" />

<h3>Thanh toán</h3>
<div><b>Còn lại cần trả:</b> <span id="remain">...</span></div>

<button id="btnPay" style="margin-top:10px;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;background:#2563eb;color:#fff;">
  Thanh toán bằng MetaMask
</button>
<button id="btnOpenMM"
  style="margin-top:10px;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;background:#111827;color:#fff;">
  Mở trang này trong MetaMask
</button>

<script>
  function openInMetaMask() {
    const currentUrl = window.location.href;
    // MetaMask dapp deeplink (mobile)
    const mm = "https://metamask.app.link/dapp/" + currentUrl.replace(/^https?:\/\//, "");
    window.location.href = mm;
  }

  document.getElementById("btnOpenMM").onclick = openInMetaMask;

  // Nếu không có MetaMask provider (Chrome/Safari mobile) thì gợi ý user bấm nút này
  window.addEventListener("load", () => {
    const hasProvider = typeof window.ethereum !== "undefined";
    if (!hasProvider) {
      // Optional: tự hiện thông báo
      console.log("No ethereum provider. Suggest open in MetaMask.");
    }
  });
</script>

<p id="payStatus" class="muted"></p>
<p id="payError" class="err"></p>

    <h4>Danh sách sản phẩm</h4>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Tên SP</th>
          <th>Giá</th>
          <th>Bảo hành (tháng)</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <!-- ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

  <script>
    // ABI tối thiểu cho hàm đọc phiếu
const ABI = [
  "function ChiTietPhieuMuaPublic(uint256 _maPhieu) view returns (uint256 maPhieu, address chuSoHuu, address chuSoHuuCu, string tenKhachHang, string soDienThoai, string[] danhSachSanPham, uint256[] giaSanPham, uint256[] BaoHanhTheoThang, uint256 tongTien, uint256 thoiDiemMua, bool dangTranhChap, bool dangChuyenNhuong)",
  "function soTienConLai(uint256 _maPhieu) view returns (uint256)",
  "function payInvoice(uint256 _maPhieu) payable"
];
    const $ = (id) => document.getElementById(id);
    function setStatus(msg) { $("status").textContent = msg; }
    function setError(msg="") { $("error").textContent = msg; }

    function fmtVND(x) {
      try {
        const n = BigInt(x.toString());
        // format thô
        return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " đ";
      } catch {
        return String(x);
      }
    }
let mmProvider, signer;

function setPayStatus(msg) { $("payStatus").textContent = msg; }
function setPayError(msg="") { $("payError").textContent = msg; }

function fmtWeiToEth(weiBigInt) {
  try { return ethers.formatEther(weiBigInt); } catch { return ""; }
}

async function connectMetaMaskSepolia() {
  if (!window.ethereum) throw new Error("Chưa có MetaMask.");

  mmProvider = new ethers.BrowserProvider(window.ethereum);
  await mmProvider.send("eth_requestAccounts", []);
  signer = await mmProvider.getSigner();

  // bắt buộc Sepolia (chainId = 11155111)
  const net = await mmProvider.getNetwork();
  if (Number(net.chainId) !== 11155111) {
    throw new Error("Bạn đang không ở mạng Sepolia. Hãy chuyển MetaMask sang Sepolia rồi thử lại.");
  }
}

async function loadRemain(contractRead, idNum) {
  // đọc số tiền còn lại từ contract
  const remain = await contractRead.soTienConLai(idNum);
  $("remain").textContent =
    `${fmtVND(remain)} (≈ ${fmtWeiToEth(remain)} ETH)`;
  return remain;
}

async function payNow(caddr, idNum, remainWei) {
  setPayError("");
  setPayStatus("Đang mở MetaMask để thanh toán...");

  await connectMetaMaskSepolia();

  const contractWrite = new ethers.Contract(caddr, ABI, signer);

  setPayStatus("Chờ bạn bấm Confirm trên MetaMask...");
  const tx = await contractWrite.payInvoice(idNum, { value: remainWei });

  setPayStatus("Đã gửi giao dịch. Đang chờ mining...");
  await tx.wait();

  setPayStatus("Thanh toán thành công ✅");
}

    async function main() {
      const params = new URLSearchParams(location.search);
      const caddr = params.get("c");
      const id = params.get("id");

      $("caddr").textContent = caddr || "";
      $("pid").textContent = id || "";

      if (!caddr || !ethers.isAddress(caddr)) return setError("Thiếu hoặc sai contract address (tham số ?c=...).");
      if (!id || isNaN(Number(id))) return setError("Thiếu hoặc sai mã phiếu (tham số ?id=...).");

      // Sepolia RPC public (có thể đổi nếu muốn)
      // ✅ RPC fallback (cái nào chạy được thì dùng)
const RPCS = [
  "https://ethereum-sepolia-rpc.publicnode.com",
  "https://sepolia.drpc.org",
  "https://rpc.sepolia.org"
];

async function getWorkingProvider() {
  for (const url of RPCS) {
    try {
      const p = new ethers.JsonRpcProvider(url);
      await p.getBlockNumber(); // test kết nối
      console.log("Using RPC:", url);
      return p;
    } catch (e) {
      console.warn("RPC failed:", url, e);
    }
  }
  throw new Error("Không gọi được RPC Sepolia từ trình duyệt. Hãy đổi mạng hoặc dùng RPC riêng (Alchemy/Infura).");
}

setStatus("Đang kết nối RPC Sepolia...");
const provider = await getWorkingProvider();

      const contract = new ethers.Contract(caddr, ABI, provider);
const idNum = BigInt(id); // dùng BigInt cho chắc

      setStatus("Đang tải dữ liệu phiếu từ blockchain...");
      const r = await contract.ChiTietPhieuMuaPublic(idNum);



      // r là tuple theo ABI
      $("content").style.display = "block";

      $("owner").textContent = r.chuSoHuu;
      $("name").textContent = r.tenKhachHang;
      $("phone").textContent = r.soDienThoai;
      $("total").textContent = fmtVND(r.tongTien);
      $("time").textContent = r.thoiDiemMua.toString();
      $("dispute").textContent = r.dangTranhChap ? "Có" : "Không";
      $("transfer").textContent = r.dangChuyenNhuong ? "Có" : "Không";

      const rows = $("rows");
      rows.innerHTML = "";

      const names = r.danhSachSanPham;
      const prices = r.giaSanPham;
      const months = r.BaoHanhTheoThang;

      for (let i = 0; i < names.length; i++) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${names[i]}</td>
          <td>${fmtVND(prices[i])}</td>
          <td>${months[i].toString()}</td>
        `;
        rows.appendChild(tr);
      }
// ====== PAYMENT UI ======
const btnPay = $("btnPay");
btnPay.disabled = false;
btnPay.style.opacity = "1";
setPayError("");
setPayStatus("");

if (r.dangTranhChap) {
  $("remain").textContent = "Phiếu đang tranh chấp — không cho thanh toán";
  btnPay.disabled = true;
  btnPay.style.opacity = "0.6";
} else {
  // load số tiền còn lại
  let remainWei = await loadRemain(contract, idNum);

  if (remainWei === 0n) {
    setPayStatus("Phiếu đã thanh toán đủ ✅");
    btnPay.disabled = true;
    btnPay.style.opacity = "0.6";
  } else {
    btnPay.onclick = async () => {
      try {
        // đọc lại remain trước khi trả (tránh trường hợp người khác vừa trả)
        remainWei = await loadRemain(contract, idNum);
        if (remainWei === 0n) {
          setPayStatus("Phiếu đã thanh toán đủ ✅");
          btnPay.disabled = true;
          btnPay.style.opacity = "0.6";
          return;
        }

        await payNow(caddr, idNum, remainWei);

        // refresh remain sau khi trả
        remainWei = await loadRemain(contract, idNum);
        if (remainWei === 0n) {
          btnPay.disabled = true;
          btnPay.style.opacity = "0.6";
        }
      } catch (e) {
        console.error(e);
        setPayError(e?.shortMessage || e?.message || String(e));
        setPayStatus("Thanh toán lỗi ❌");
      }
    };
  }
}

      setStatus("Tải xong ✅");
    }

    main().catch(e => {
      console.error(e);
      setError(e?.shortMessage || e?.message || String(e));
      setStatus("Có lỗi khi tải phiếu ❌");
    });
  </script>
</body>
</html>




