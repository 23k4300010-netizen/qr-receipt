<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phi·∫øu mua s·∫Øm</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 980px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 12px; }
    .muted { color:#666; }
    .ok { color:#0a7a2f; }
    .err { color:#b00020; white-space: pre-wrap; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    code { background:#f6f6f6; padding: 2px 6px; border-radius: 6px; word-break: break-all; }
    .btn { margin-top:10px; padding:10px 14px; border-radius:10px; border:0; cursor:pointer; }
    .btnPrimary { background:#2563eb; color:#fff; }
    .btnDark { background:#111827; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .row2 { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { display:inline-block; padding:4px 10px; border:1px solid #eee; border-radius:999px; background:#fafafa; }
    .list { margin: 10px 0 0; padding: 0; list-style: none; }
    .list li { display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px; border:1px solid #eee; border-radius:10px; margin-top:8px; }
    .list .left { display:flex; flex-direction:column; gap:2px; }
    .list .title { font-weight:600; }
    .list .sub { color:#666; font-size: 13px; }
    hr { margin:16px 0; border:none; border-top:1px solid #eee; }
  </style>
</head>
<body>
  <h2>Phi·∫øu mua s·∫Øm</h2>
  <p class="muted">
    Trang n√†y ƒë·ªçc d·ªØ li·ªáu t·ª´ blockchain (Sepolia). Kh√¥ng c·∫ßn MetaMask v·∫´n xem ƒë∆∞·ª£c chi ti·∫øt phi·∫øu.
    <br/>Mu·ªën <b>thanh to√°n</b> / <b>xem ƒëi·ªÉm</b> / <b>ƒë·ªïi qu√†</b> th√¨ c·∫ßn MetaMask.
  </p>

  <div class="card">
    <div><b>Contract:</b> <code id="caddr"></code></div>
    <div><b>M√£ phi·∫øu:</b> <code id="pid"></code></div>
    <p id="status" class="muted"></p>
    <p id="error" class="err"></p>
  </div>

  <div id="content" class="card" style="display:none;">
    <h3>Chi ti·∫øt phi·∫øu</h3>
    <div><b>Ch·ªß s·ªü h·ªØu:</b> <code id="owner"></code></div>
    <div><b>T√™n kh√°ch:</b> <span id="name"></span></div>
    <div><b>SƒêT:</b> <span id="phone"></span></div>
    <div><b>T·ªïng ti·ªÅn:</b> <span id="total"></span></div>
    <div><b>Th·ªùi ƒëi·ªÉm mua (unix):</b> <span id="time"></span></div>
    <div><b>Tranh ch·∫•p:</b> <span id="dispute"></span></div>
    <div><b>Chuy·ªÉn nh∆∞·ª£ng:</b> <span id="transfer"></span></div>

    <hr/>

    <h3>Thanh to√°n</h3>
    <div><b>C√≤n l·∫°i c·∫ßn tr·∫£:</b> <span id="remain">...</span></div>

    <div class="row2">
      <button id="btnPay" class="btn btnPrimary">Thanh to√°n b·∫±ng MetaMask</button>
      <button id="btnOpenMM" class="btn btnDark">M·ªü trang n√†y trong MetaMask</button>
    </div>

    <p id="payStatus" class="muted"></p>
    <p id="payError" class="err"></p>

    <hr/>

    <h3>üéÅ ƒêi·ªÉm & ƒê·ªïi qu√†</h3>
    <div class="row2">
      <span class="pill">V√≠ ƒëang m·ªü: <code id="mmAddr">ch∆∞a k·∫øt n·ªëi</code></span>
      <button id="btnConnect" class="btn btnPrimary">K·∫øt n·ªëi MetaMask</button>
    </div>

    <p class="muted" style="margin-top:8px;">
      ƒêi·ªÉm & qu√† ƒë∆∞·ª£c t√≠nh theo <b>v√≠ ƒëang m·ªü trang</b> (MetaMask). N·∫øu b·∫°n mu·ªën t√≠nh theo ‚Äúch·ªß s·ªü h·ªØu phi·∫øu‚Äù th√¨ ph·∫£i m·ªü b·∫±ng ƒë√∫ng v√≠ ƒë√≥.
    </p>

    <div><b>ƒêi·ªÉm hi·ªán t·∫°i:</b> <span id="points">...</span></div>

    <div style="margin-top:10px;">
      <b>Qu√† ƒë·ªïi ƒë∆∞·ª£c:</b>
      <ul id="giftList" class="list"></ul>
    </div>

    <p id="giftStatus" class="muted"></p>
    <p id="giftError" class="err"></p>

    <hr/>

    <h4>Danh s√°ch s·∫£n ph·∫©m</h4>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>T√™n SP</th>
          <th>Gi√°</th>
          <th>B·∫£o h√†nh (th√°ng)</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <!-- ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

  <script>
    // ABI t·ªëi thi·ªÉu cho web ƒë·ªçc phi·∫øu + thanh to√°n + ƒëi·ªÉm/ƒë·ªïi qu√†
    const ABI = [
      "function ChiTietPhieuMuaPublic(uint256 _maPhieu) view returns (uint256 maPhieu, address chuSoHuu, address chuSoHuuCu, string tenKhachHang, string soDienThoai, string[] danhSachSanPham, uint256[] giaSanPham, uint256[] BaoHanhTheoThang, uint256 tongTien, uint256 thoiDiemMua, bool dangTranhChap, bool dangChuyenNhuong)",
      "function soTienConLai(uint256 _maPhieu) view returns (uint256)",
      "function payInvoice(uint256 _maPhieu) payable",
      "function xemDiemTichLuy(address _khach) view returns (uint256)",
      "function QuaCoTheDoi() view returns (string[] memory)",
      "function doiQuaTheoSoDiemNhap(uint256 _soDiemMuonDoi) returns (string memory)"
    ];

    const $ = (id) => document.getElementById(id);
    function setStatus(msg) { $("status").textContent = msg; }
    function setError(msg="") { $("error").textContent = msg; }

    function setPayStatus(msg) { $("payStatus").textContent = msg; }
    function setPayError(msg="") { $("payError").textContent = msg; }

    function setGiftStatus(msg) { $("giftStatus").textContent = msg; }
    function setGiftError(msg="") { $("giftError").textContent = msg; }

    function fmtVND(x) {
      try {
        const n = BigInt(x.toString());
        return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " ƒë";
      } catch {
        return String(x);
      }
    }

    function fmtWeiToEth(weiBigInt) {
      try { return ethers.formatEther(weiBigInt); } catch { return ""; }
    }

    // Sepolia RPC fallback
    const RPCS = [
      "https://ethereum-sepolia-rpc.publicnode.com",
      "https://sepolia.drpc.org",
      "https://rpc.sepolia.org"
    ];

    async function getWorkingProvider() {
      for (const url of RPCS) {
        try {
          const p = new ethers.JsonRpcProvider(url);
          await p.getBlockNumber();
          return p;
        } catch (e) {}
      }
      throw new Error("Kh√¥ng g·ªçi ƒë∆∞·ª£c RPC Sepolia t·ª´ tr√¨nh duy·ªát. H√£y th·ª≠ m·∫°ng kh√°c ho·∫∑c d√πng RPC ri√™ng (Alchemy/Infura).");
    }

    // ===== MetaMask helpers =====
    let mmProvider = null;
    let signer = null;

    async function connectMetaMaskSepolia() {
      if (!window.ethereum) throw new Error("Ch∆∞a c√≥ MetaMask (ho·∫∑c ƒëang m·ªü b·∫±ng tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ extension/app).");

      mmProvider = new ethers.BrowserProvider(window.ethereum);
      await mmProvider.send("eth_requestAccounts", []);
      signer = await mmProvider.getSigner();

      const net = await mmProvider.getNetwork();
      if (Number(net.chainId) !== 11155111) {
        throw new Error("B·∫°n ƒëang kh√¥ng ·ªü m·∫°ng Sepolia. H√£y chuy·ªÉn MetaMask sang Sepolia r·ªìi th·ª≠ l·∫°i.");
      }

      const a = await signer.getAddress();
      $("mmAddr").textContent = a;
      return a;
    }

    function makeMetaMaskDeepLink(currentUrl) {
      // MetaMask mobile: m·ªü dapp trong MetaMask Browser
      // d·∫°ng: https://metamask.app.link/dapp/<domain + path + query>
      const clean = currentUrl.replace(/^https?:\/\//, "");
      return "https://metamask.app.link/dapp/" + clean;
    }

    // ===== Payment =====
    async function loadRemain(contractRead, idNum) {
      const remain = await contractRead.soTienConLai(idNum);
      $("remain").textContent = `${fmtVND(remain)} (‚âà ${fmtWeiToEth(remain)} ETH)`;
      return remain;
    }

    async function payNow(caddr, idNum, remainWei) {
      setPayError("");
      setPayStatus("ƒêang k·∫øt n·ªëi MetaMask...");

      await connectMetaMaskSepolia();
      const contractWrite = new ethers.Contract(caddr, ABI, signer);

      setPayStatus("Ch·ªù b·∫°n b·∫•m Confirm tr√™n MetaMask...");
      const tx = await contractWrite.payInvoice(idNum, { value: remainWei });

      setPayStatus("ƒê√£ g·ª≠i giao d·ªãch. ƒêang ch·ªù mining...");
      await tx.wait();

      setPayStatus("Thanh to√°n th√†nh c√¥ng ‚úÖ");
    }

    // ===== Gifts =====
    function parsePointsFromGiftText(s) {
      // v√≠ d·ª•: "1 - C√°p s·∫°c nhanh | ƒêi·ªÉm c·∫ßn: 150"
      const m = String(s).match(/ƒêi·ªÉm c·∫ßn:\s*([0-9]+)/i);
      if (!m) return null;
      try { return BigInt(m[1]); } catch { return null; }
    }

    async function refreshGifts(caddr) {
      setGiftError("");
      setGiftStatus("");

      // b·∫Øt bu·ªôc MetaMask ƒë·ªÉ call v√¨ contract check msg.sender
      const addr = await connectMetaMaskSepolia();

      const contractWrite = new ethers.Contract(caddr, ABI, signer);

      setGiftStatus("ƒêang t·∫£i ƒëi·ªÉm & qu√†...");
      const points = await contractWrite.xemDiemTichLuy(addr);
      $("points").textContent = points.toString();

      const listEl = $("giftList");
      listEl.innerHTML = "";

      let gifts = [];
      try {
        gifts = await contractWrite.QuaCoTheDoi();
      } catch (e) {
        // N·∫øu kh√¥ng c√≥ qu√† ƒë·ªïi ƒë∆∞·ª£c, h√†m ƒëang require(dem>0) -> revert
        setGiftStatus("");
        setGiftError("Hi·ªán ch∆∞a c√≥ qu√† n√†o ƒë·ªïi ƒë∆∞·ª£c (ch∆∞a ƒë·ªß ƒëi·ªÉm).");
        return;
      }

      if (!gifts || gifts.length === 0) {
        setGiftStatus("");
        setGiftError("Hi·ªán ch∆∞a c√≥ qu√† n√†o ƒë·ªïi ƒë∆∞·ª£c (ch∆∞a ƒë·ªß ƒëi·ªÉm).");
        return;
      }

      for (const g of gifts) {
        const need = parsePointsFromGiftText(g);

        const li = document.createElement("li");
        li.innerHTML = `
          <div class="left">
            <div class="title">${g}</div>
            <div class="sub">B·∫•m ‚Äúƒê·ªïi‚Äù ƒë·ªÉ MetaMask x√°c nh·∫≠n</div>
          </div>
          <button class="btn btnPrimary">ƒê·ªïi</button>
        `;
        const btn = li.querySelector("button");

        btn.onclick = async () => {
          try {
            setGiftError("");
            setGiftStatus("ƒêang m·ªü MetaMask ƒë·ªÉ ƒë·ªïi qu√†...");

            if (need === null) throw new Error("Kh√¥ng parse ƒë∆∞·ª£c s·ªë ƒëi·ªÉm c·∫ßn t·ª´ d√≤ng qu√†.");

            const tx = await contractWrite.doiQuaTheoSoDiemNhap(need);
            setGiftStatus("ƒê√£ g·ª≠i giao d·ªãch. ƒêang ch·ªù mining...");
            const rc = await tx.wait();

            setGiftStatus("ƒê·ªïi qu√† th√†nh c√¥ng ‚úÖ (ƒëang refresh ƒëi·ªÉm...)");
            await refreshGifts(caddr);
          } catch (e) {
            console.error(e);
            setGiftError(e?.shortMessage || e?.message || String(e));
            setGiftStatus("ƒê·ªïi qu√† l·ªói ‚ùå");
          }
        };

        listEl.appendChild(li);
      }

      setGiftStatus("T·∫£i xong ‚úÖ");
    }

    // ===== Main =====
    async function main() {
      const params = new URLSearchParams(location.search);
      const caddr = params.get("c");
      const id = params.get("id");

      $("caddr").textContent = caddr || "";
      $("pid").textContent = id || "";

      if (!caddr || !ethers.isAddress(caddr)) return setError("Thi·∫øu ho·∫∑c sai contract address (tham s·ªë ?c=...).");
      if (!id || isNaN(Number(id))) return setError("Thi·∫øu ho·∫∑c sai m√£ phi·∫øu (tham s·ªë ?id=...).");

      setStatus("ƒêang k·∫øt n·ªëi RPC Sepolia...");
      const provider = await getWorkingProvider();
      const contractRead = new ethers.Contract(caddr, ABI, provider);
      const idNum = BigInt(id);

      setStatus("ƒêang t·∫£i d·ªØ li·ªáu phi·∫øu t·ª´ blockchain...");
      const r = await contractRead.ChiTietPhieuMuaPublic(idNum);

      $("content").style.display = "block";

      $("owner").textContent = r.chuSoHuu;
      $("name").textContent = r.tenKhachHang;
      $("phone").textContent = r.soDienThoai;
      $("total").textContent = fmtVND(r.tongTien);
      $("time").textContent = r.thoiDiemMua.toString();
      $("dispute").textContent = r.dangTranhChap ? "C√≥" : "Kh√¥ng";
      $("transfer").textContent = r.dangChuyenNhuong ? "C√≥" : "Kh√¥ng";

      // Render products
      const rows = $("rows");
      rows.innerHTML = "";
      const names = r.danhSachSanPham;
      const prices = r.giaSanPham;
      const months = r.BaoHanhTheoThang;

      for (let i = 0; i < names.length; i++) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${names[i]}</td>
          <td>${fmtVND(prices[i])}</td>
          <td>${months[i].toString()}</td>
        `;
        rows.appendChild(tr);
      }

      // MetaMask deep link button (mobile-friendly)
      $("btnOpenMM").onclick = () => {
        const url = makeMetaMaskDeepLink(location.href);
        window.location.href = url;
      };

      // Payment UI
      const btnPay = $("btnPay");
      btnPay.disabled = false;

      setPayError("");
      setPayStatus("");

      if (r.dangTranhChap) {
        $("remain").textContent = "Phi·∫øu ƒëang tranh ch·∫•p ‚Äî kh√¥ng cho thanh to√°n";
        btnPay.disabled = true;
      } else {
        let remainWei = await loadRemain(contractRead, idNum);

        if (remainWei === 0n) {
          setPayStatus("Phi·∫øu ƒë√£ thanh to√°n ƒë·ªß ‚úÖ");
          btnPay.disabled = true;
        } else {
          btnPay.onclick = async () => {
            try {
              // ƒë·ªçc l·∫°i remain tr∆∞·ªõc khi tr·∫£
              remainWei = await loadRemain(contractRead, idNum);
              if (remainWei === 0n) {
                setPayStatus("Phi·∫øu ƒë√£ thanh to√°n ƒë·ªß ‚úÖ");
                btnPay.disabled = true;
                return;
              }

              await payNow(caddr, idNum, remainWei);

              // refresh remain sau khi tr·∫£
              remainWei = await loadRemain(contractRead, idNum);
              if (remainWei === 0n) btnPay.disabled = true;

            } catch (e) {
              console.error(e);
              setPayError(e?.shortMessage || e?.message || String(e));
              setPayStatus("Thanh to√°n l·ªói ‚ùå");
            }
          };
        }
      }

      // Gifts UI
      $("btnConnect").onclick = async () => {
        try {
          setGiftError("");
          setGiftStatus("ƒêang k·∫øt n·ªëi MetaMask...");
          await refreshGifts(caddr);
        } catch (e) {
          console.error(e);
          setGiftError(e?.shortMessage || e?.message || String(e));
          setGiftStatus("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c MetaMask ‚ùå");
        }
      };

      // auto-hint n·∫øu c√≥ MetaMask
      if (window.ethereum) {
        $("points").textContent = "(b·∫•m K·∫øt n·ªëi MetaMask ƒë·ªÉ xem)";
      } else {
        $("points").textContent = "(c·∫ßn MetaMask)";
        setGiftError("B·∫°n ƒëang m·ªü b·∫±ng tr√¨nh duy·ªát kh√¥ng c√≥ MetaMask. N·∫øu d√πng ƒëi·ªán tho·∫°i: m·ªü link b·∫±ng MetaMask Browser.");
      }

      setStatus("T·∫£i xong ‚úÖ");
    }

    main().catch(e => {
      console.error(e);
      setError(e?.shortMessage || e?.message || String(e));
      setStatus("C√≥ l·ªói khi t·∫£i phi·∫øu ‚ùå");
    });
  </script>
</body>
</html>
